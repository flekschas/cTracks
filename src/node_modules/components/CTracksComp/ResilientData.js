import hamradio from 'hamradio'

let servers = []
let tracks = []
let variants = []

let subscriptions = []

export default {
  initialize (prefix) {
    servers = JSON.parse((sessionStorage.getItem(`${prefix}/servers`))) || []
    tracks = JSON.parse((sessionStorage.getItem(`${prefix}/tracks`))) || []
    variants = JSON.parse((sessionStorage.getItem(`${prefix}/variants`))) || []

    subscriptions.forEach(sub => sub.unsubscribe())
    subscriptions = [
      hamradio.subscribe('track/add', (name, data) => {
        tracks.push(data)
        sessionStorage.setItem(`${prefix}/tracks`, JSON.stringify(tracks))
      }),
      hamradio.subscribe('track/modify', (name, data) => {
        tracks = tracks.filter(track => data.track.uid !== track.track.uid)
        tracks.push(data)
        sessionStorage.setItem(`${prefix}/tracks`, JSON.stringify(tracks))
      }),
      hamradio.subscribe('track/remove', (name, data) => {
        tracks = tracks.filter(track => data !== track.track.uid)
        sessionStorage.setItem(`${prefix}/tracks`, JSON.stringify(tracks))
      }),
      hamradio.subscribe('server/add', (name, data) => {
        servers.push(data)
        sessionStorage.setItem(`${prefix}/servers`, JSON.stringify(servers))
      }),
      hamradio.subscribe('cTracks/variants', (name, data) => {
        variants = data
        sessionStorage.setItem(`${prefix}/variants`, JSON.stringify(data))
      })
    ]
  },
  servers () {
    return [...servers]
  },
  tracks () {
    return [...tracks]
  },
  variants () {
    return [...variants]
  }
}
